import { useState } from "react";
import { initializeApp } from "firebase/app";
import { getFirestore, collection, query, where, getDocs } from "firebase/firestore";

const firebaseConfig = {
  apiKey: "AIzaSyBPhdtFn5d3vDYmfJ7aIjud4qXX4y5chgo",
  authDomain: "mitumorimeijin.firebaseapp.com",
  projectId: "mitumorimeijin",
  storageBucket: "mitumorimeijin.firebasestorage.app",
  messagingSenderId: "1011065875219",
  appId: "1:1011065875219:web:986be944fa26b8a2d188e6",
  measurementId: "G-TM5QPNW91R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

export default function CompanySearch() {
  const [search, setSearch] = useState("");
  const [suggestions, setSuggestions] = useState([]);
  const [selectedCompany, setSelectedCompany] = useState(null);

  const handleSearch = async (value) => {
    setSearch(value);
    if (value.length < 2) {
      setSuggestions([]);
      return;
    }

    const q = query(collection(db, "companies"), where("name", ">=", value), where("name", "<=", value + "\uf8ff"));
    const querySnapshot = await getDocs(q);

    const results = [];
    querySnapshot.forEach((doc) => {
      results.push({ id: doc.id, ...doc.data() });
    });

    setSuggestions(results);
  };

  const handleSelect = (company) => {
    setSelectedCompany(company);
    setSearch(company.name);
    setSuggestions([]);
  };

  return (
    <div>
      <input
        type="text"
        value={search}
        onChange={(e) => handleSearch(e.target.value)}
        placeholder="会社名を入力..."
      />
      {suggestions.length > 0 && (
        <ul>
          {suggestions.map((company) => (
            <li key={company.id} onClick={() => handleSelect(company)}>
              {company.name}
            </li>
          ))}
        </ul>
      )}

      {selectedCompany && (
        <div>
          <p>選択した会社: {selectedCompany.name}</p>
          <p>住所: {selectedCompany.address}</p>
        </div>
      )}
    </div>
  );
}

